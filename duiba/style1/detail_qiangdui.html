<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta content="telephone=no" name="format-detection"/>
    <title>行车电子狗激活码</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <link rel="stylesheet" href="../css/normalize.min.css">
    <link rel="stylesheet" href="../css/modal.min.css">
    <link rel="stylesheet" href="../css/detail.css">
    <style>
        .powered-logo{width:27px;}
    </style>
    <style>
        .theme-color{color: #0b45fc;}
        .theme-bgcolor{background-color: #0b45fc;}
        .theme-bordercolor{border-color: #0b45fc;}
        /* radio */
        .radio-group.cur{border-color:#0b45fc; }
        .radio-group .cur-arrow{border-color: #0b45fc transparent transparent #0b45fc;}
        .description a {color: #0b45fc;}
    </style>
    <link rel="stylesheet" type="text/css" href="../css/ordinaryRecommend.css">
</head>
<body>
<div id="db-content">
    <div class="db-banner-style">
        <div class="db-banner-swipe" id="swipe">
            <div>
                <!-- banner循环开始 -->

                <a><img src="http://yun.duiba.com.cn/images/k4b3an3p84.png"/></a>

                <!-- banner循环结束 -->
            </div>
        </div>
        <div class="db-banner-position">
            <strong>1</strong><span>/1</span>
        </div>
    </div>
    <header>
        <div class="item-info">
            <div class="item-title">
                <h3>行车电子狗激活码</h3>
                    <span>抢兑中</span>
            </div>
            <div class="price"><span class="num theme-color">50</span><span class="unit theme-color">金币</span>
                <span class="rmb">￥30.0</span>
            </div>
        </div>
        <div class="validDate">
            <i class="arrow"></i><strong>有效期：</strong><span>2016-02-24至2016-04-15</span>
        </div>
    </header>
    <section>
        <p class="title">
            <i class="arrow"></i><span>详情说明：</span>
        </p>
        <div class="description">
            <h4>价值30元的图吧行车电子狗VIP激活码，免费送！图吧导航专注导航8年，提供专业精确安全的导航体验</h4><ul><li>覆盖全国，超过140万个测速、信号灯、违章摄像头，超过60种安全警示</li></ul><h4>使用规则</h4><ul><li>每位用户仅限兑换使用一次</li><li><span class="wysiwyg-color-red">图吧导航（3D地图）Android用户专享</span></li><li>每个用户仅限兑换使用一次，券码有效期自激活后6个月内有效</li><li>图吧郑重承诺：每月更新</li><li>商家客服热线：4006616677</li><li>商品或兑换流程等问题，也可直接联系积分商城客服专线：400-084-6200（工作日9:00至18:00）</li></ul><h4>使用流程</h4><ol><li>注册或登录<a href="http://yun.duiba.com.cn/upload/trinity_tags_V8.6.6_r3_cbba114_duiba.apk" data-tag="is-link">图吧导航（3D地图）Android</a> -&gt; 点击底部菜单“数据”-&gt; 进入数据主界面</li><li>点击顶部中间的页签“数据”-&gt; 再点击右下角“数据助手”，输入激活码后即可</li></ol>
        </div>
    </section>



    <div class="statement">
        <p>
            <i class="arrow"></i><span>重要声明：</span>
        </p>
        <ul>
            <li>除商品本身不能正常兑换外，商品一经兑换，一律不退还金币，请用户兑换前仔细参照使用规则、使用说明、有效期等重要信息；</li>
            <li>对于每位用户限兑一次的商品，若发现多个用户账号使用相同手机号或收货地址兑换同一商品，则自动取消订单，被扣除的金币不退还；</li>
            <li>通过非法途径获得金币后进行的正常兑换行为，或不按商品使用规则进行兑换，商家有权不提供服务；</li>
            <li>凡以不正当手段（包括但不限于作弊、扰乱系统、实施网络攻击等）进行兑换，平台有权终止该次兑换</li>
        </ul>
    </div>

    <div class="recommandLocation" style='margin-top:10px; display:none'>
        <em></em><i></i><span>为您推荐</span><em></em>
    </div>
    <div class="recommandLocationItems clearfix" style='display:none'>
    </div>
    <p class="apple">Powered by <img class="powered-logo" src="http://yun.duiba.com.cn/webapp/img/webappLogo.png"/></p>
    <footer>
        <div class="timedown"><span class="dateRange"></span><i></i><strong><span class="hourTens"></span> <span class="hourOnes"></span><span>时</span><span class="minuteTens"></span> <span class="minuteOnes"></span><span>分</span><span class="secondTens"></span> <span class="secondOnes"></span><span>秒</span></strong></div>
        <button type="button" class="submit theme-bgcolor" >马上兑换</button>
    </footer>
</div>
<div class="captcha">
    <div class="captcha-dialog">
    </div>
</div>
</body>
<script src="../js/zepto.min.js"></script>
<script src="../js/swipe.min.js?t=20151012"></script>
<script src="../js/modal.min.js?t=20160112"></script>
<script src="../js/fastclick.js"></script>
<script>
    var CFG={"endTime":"","limitdayend":false,"limitdaystart":false,"mycredits":10000,"needcredits":"50","serverTime":"22:25:42","startTime":"","startday":"","status":8,"timedown":false};
    //fastclick
    Origami.fastclick(document.body);
    $(function(){
        (function($){
            var swipelength=$('.db-banner-swipe').children('div').children('a').length;
            $('.db-banner-position span').html('/'+swipelength);
            if(swipelength>1){
                window.bannerSlider =  Swipe(document.getElementById('swipe'), {
                    auto: 3000,
                    startSlide: 0,
                    continuous: true,
                    disableScroll:false,
                    callback: function(index) {
                        if((index+1)>swipelength){
                            index=index%2;
                        }
                        $('.db-banner-position strong').html(index+1)
                    }
                });
                $('.db-banner-position').css("visibility","visible")
            }else{
                $('.db-banner-swipe').css("visibility","visible")
            }
        })(Zepto)
        if(CFG.timedown){
            if(CFG.startTime !=='' && CFG.endTime !==''){
                var startTime   =CFG.startTime.split(':');
                var endTime     =CFG.endTime.split(':');
                var serverTime  =CFG.serverTime.split(':');
                var _startTime  =new Date();
                var _endTime    =new Date();
                var _serverTime =new Date();
                var zerotime    =new Date();
                _startTime.setHours(startTime[0],startTime[1],0,0);
                _endTime.setHours(endTime[0],endTime[1],0,0);
                _serverTime.setHours(serverTime[0],serverTime[1],serverTime[2],0);
                zerotime.setHours(0,0,0,0);
                switch (CFG.status){
                    case 7:
                        startTimer();
                        break;
                    case 8:
                        var leaveEndTime=_endTime-_serverTime;
                        endTimer(leaveEndTime);
                        break;
                    case 11:
                    case 15:
                    case 16:
                        if(_serverTime <_startTime){
                            startTimer();
                        }
                        else if(_serverTime >= _startTime && _serverTime < _endTime){
                            var leaveEndTime=_endTime-_serverTime;
                            endTimer(leaveEndTime);
                        }
                        break;
                }
            }else{
                console.error('开始时间或结束时间错误')
            }
        }

        if(CFG.limitdaystart){
            var start_time = "00:00";
            if(CFG.timedown){
                start_time = CFG.startTime;
            }
            $('.dateRange').siblings().remove();
            $('.dateRange').html(CFG.startday+" "+start_time+" 开始");
            $('.timedown').show();
        }else if(CFG.limitdayend){
            $('.timedown').hide();
            $('.submit').prop('disabled',true).html('已结束');
        }
        var day_status = "8";
        if(day_status==1
                || day_status==2
                || day_status==3
                || day_status==4
                || day_status==5
                || day_status==6
                || day_status==10
        ){
            $('.timedown').hide();
        }

        $('#db-content').css('padding-bottom',$('footer').height());

        $('.submit').on('click',function(){
            $.modal({
                type:'confirm',
                title:'确定使用&nbsp;'+CFG.needcredits+'&nbsp;金币兑换？',
                section:'<p>兑换码将在兑换成功后发送给您，请按后续的提示使用。</p>',
                callback:{
                    save:function(){
                        window.loading=$.modal({
                            type:'loading',
                            title:'正在处理，请稍后···'
                        })
                        var dba='';

                        $.ajax({
                            url: '/CouponExchange/exchange',
                            type: 'POST',
                            dataType: 'json',
                            data:{token:_token,appItemId:"",itemId:"532",dba:dba},
                            timeout:60000,
                            success: function(result){
                                if(result.jump){//result.jump秒杀排队页面URL
                                    window.location.href=result.jump;
                                }else if(result.success){
                                    if(result.captcha){
                                        requireCaptcha();
                                    }else{
                                        retry(result);
                                    }
                                }else{
                                    window.loading.close();
                                    $.modal({
                                        type:'alert',
                                        title:CFG.timedown?'好可惜没抢到，再试一次吧':result.message,
                                        callback:{
                                            save:function(){
                                                window.location.reload();
                                            }
                                        }
                                    });
                                }
                            },
                            error: function(e) {
                                window.loading.close();
                                $.modal({
                                    type:'alert',
                                    title:'请求超时',
                                    callback:{
                                        save:function(){
                                            window.location.reload();
                                        }
                                    }
                                });
                            }
                        });
                    }
                }
            })
        })
        window.gt_custom_ajax = function(result, id, message) {
            if(result) {
                captchaHide();
                window.loading=$.modal({
                    type:'loading',
                    title:'正在处理，请稍后···'
                })
                var dba='';
                $.ajax({
                    url: '/CouponExchange/exchange',
                    type: 'POST',
                    dataType: 'json',
                    data:{"geetest_challenge":$('[name="geetest_challenge"]').val(),"geetest_validate":$('[name="geetest_validate"]').val(),"geetest_seccode":$('[name="geetest_seccode"]').val(),appItemId:"",itemId:"532",token: _token,dba:dba},
                    timeout:60000,
                    success: function(result){
                        if(result.jump){
                            window.location.href=result.jump;
                        }else if(result.success){
                            retry(result);
                        }else{
                            window.loading.close();
                            $.modal({
                                type:'alert',
                                title:CFG.timedown?'好可惜没抢到，再试一次吧':result.message,
                                callback:{
                                    save:function(){
                                        window.location.reload();
                                    }
                                }
                            });
                        }
                    },
                    error: function(e) {
                        window.loading.close();
                        $.modal({
                            type:'alert',
                            title:'请求超时',
                            callback:{
                                save:function(){
                                    window.location.reload();
                                }
                            }
                        });
                    }
                });
            }
        }
        function retry(result){
            var tg = result.url;
            var checkdata = "orderId=" + result.orderId;
            var times = 0;
            check_state(checkdata, tg, times);
            myint=setInterval(function() {
                times = times + 1;
                check_state(checkdata, tg, times);
            }, 1000);
        }
        function check_state(data, tg, times) {
            $.ajax({
                url : '/mobile/orderStatusQuery/',
                data : data,
                dataType : "json",
                type : "POST",
                success : function(result) {
                    if ((result.status == "processing") && (times < 3)) {
                    } else {
                        window.loading.close();
                        window.clearInterval(myint);
                        window.location.replace(tg);
                    }
                }
            });
        }
        function requireCaptcha(){
            window.loading.close();
            $('#db-content').addClass('filter-blur');
            $('.captcha').show();
            document.ontouchmove = function(event){
                event.preventDefault();
            }
            var oHead = document.getElementsByClassName('captcha-dialog').item(0);
            oHead.innerHTML='';
            var oScript= document.createElement("script");
            oScript.type = "text/javascript";
            $.ajax({
                type:'GET',
                url:'/Capthca/startCapthca',
                dataType:'json',
                timeout:60000,
                success:function(result){
                    if(result.success){
                        oScript.src='http://api.geetest.com/get.php?gt='+result.gt+'&challenge='+result.challenge+'&width=100%';
                        oHead.appendChild(oScript);
                    }else{
                        captchaHide();
                        $.modal({
                            type:'alert',
                            title:result.message,
                            callback:{
                                save:function(){
                                    window.location.reload();
                                }
                            }
                        });
                    }
                },
                error:function(){
                    captchaHide();
                    $.modal({
                        type:'alert',
                        title:'请求超时',
                        callback:{
                            save:function(){
                                window.location.reload();
                            }
                        }
                    });
                }
            })
        }
        function captchaHide(){
            $('.captcha').hide();
            $('#db-content').removeClass('filter-blur');
        }
        function startTimer(){
            $('.dateRange').html((parseInt(startTime[0])<10?'0'+parseInt(startTime[0]):startTime[0])+':'+(parseInt(startTime[1])<10?'0'+parseInt(startTime[1]):startTime[1])+'开始：')
            var leaveStartTime=_startTime-_serverTime;
            timeDown(leaveStartTime)
            $('.timedown').show();
            var startTimer=setInterval(function(){
                leaveStartTime-=1000;
                timeDown(leaveStartTime)
                if(leaveStartTime==0){
                    clearInterval(startTimer);
                    if(CFG.status !== 10 && CFG.status !== 15 && CFG.status !== 16){
                        $('.submit').prop('disabled',false).html('马上兑换');
                    }
                    //从即将开始到马上兑换
                    var leaveEndTime=_endTime-_startTime;
                    endTimer(leaveEndTime);
                }
            },1000)
        }
        function endTimer(leaveEndTime){
            $('.dateRange').html((parseInt(endTime[0])<10?'0'+parseInt(endTime[0]):endTime[0])+':'+(parseInt(endTime[1])<10?'0'+parseInt(endTime[1]):endTime[1])+'结束：')
            timeDown(leaveEndTime);
            $('.timedown').show();
            var endTimer=setInterval(function(){
                leaveEndTime-=1000;
                timeDown(leaveEndTime)
                if(leaveEndTime==0){
                    clearInterval(endTimer);
                    if(CFG.status !== 10 && CFG.status !== 15 && CFG.status !== 16){
                        $('.submit').prop('disabled',true).html('已结束')
                    }
                    $('.timedown').hide();
                    $('#db-content').css('padding-bottom',$('footer').height())
                }
            },1000)
        }
        function timeDown(remainTime){
            var remainTimeHour=parseInt((remainTime/1000)/3600);
            var remainTimeMinute=parseInt(((remainTime/1000)-remainTimeHour*3600)/60);
            var remainTimeSecond=parseInt(((remainTime/1000)-remainTimeHour*3600-remainTimeMinute*60));
            var hourTens=parseInt((remainTimeHour/10));
            var hourOnes=parseInt((remainTimeHour%10));
            var minuteTens=parseInt((remainTimeMinute/10));
            var minuteTOnes=parseInt((remainTimeMinute%10));
            var secondTens=parseInt((remainTimeSecond/10));
            var secondOnes=parseInt((remainTimeSecond%10));
            $('.hourTens').html(hourTens);
            $('.hourOnes').html(hourOnes);
            $('.minuteTens').html(minuteTens);
            $('.minuteOnes').html(minuteTOnes);
            $('.secondTens').html(secondTens);
            $('.secondOnes').html(secondOnes);
        }
    });
    (function(){
        $(function(){
            if(navigator.userAgent.match(/(iphone|ipad|Android|ios)/ig)){
                //app状态监控，用户10秒不触碰屏幕，即有可能离开了app，停止banner
                var inApp=true;
                function inAppTimerFn(){
                    window.inAppTimer=setTimeout(function(){
                        inApp=false;
                        if(window.bannerSlider){
                            bannerSlider.stop();
                        }
                    }, 12000);
                }
                inAppTimerFn();
                document.addEventListener('touchend',function(e){
                    if(window.inAppTimer) clearTimeout(window.inAppTimer);
                    if(!inApp){
                        inApp=true;
                        if(window.bannerSlider){
                            bannerSlider.begin();
                        }
                    }
                    inAppTimerFn();
                },false)
            }
        })
    })()

    function judgeCookie(offset) {
        var endstr = document.cookie.indexOf(";", offset);
        if (endstr == -1)
            endstr = document.cookie.length;
        return unescape(document.cookie.substring(offset, endstr));
    }
    function GetCookie(name) {
        var arg = name + "=";
        var alen = arg.length;
        var clen = document.cookie.length;
        var i = 0;
        while (i < clen) {
            var j = i + alen;
            if (document.cookie.substring(i, j) == arg)
                return judgeCookie(j);
            i = document.cookie.indexOf(" ", i) + 1;
            if (i == 0)
                break;
        }
        return null;
    }
    function SetCookie(name, value) {
        var argv = SetCookie.arguments;
        var argc = SetCookie.arguments.length;
        var expires = (2 < argc) ? argv[2] : null;
        var path = (3 < argc) ? argv[3] : null;
        var domain = (4 < argc) ? argv[4] : null;
        var secure = (5 < argc) ? argv[5] : false;
        document.cookie = name
                + "="
                + escape(value)
                + ((expires == null) ? "" : ("; expires=" + expires
                        .toGMTString()))
                + ((path == null) ? "" : ("; path=" + path))
                + ((domain == null) ? "" : ("; domain=" + domain))
                + ((secure == true) ? "; secure" : "");
    }
    var expdate = new Date();
    var visits;
    expdate.setTime(expdate.getTime() + (24 * 60 * 60 * 1000)); //设置cookie时间为一天
    if (!(visits = GetCookie("visits"))) {
        visits = 0;
    }
    var oldjessionid = GetCookie("calculate");
    if (!oldjessionid) {
        oldjessionid = "111";
    }
    var newjessionid = GetCookie("index");
    if (oldjessionid != newjessionid) {
        visits++;
        SetCookie("calculate", newjessionid, expdate, "/", null, false);
        SetCookie("visits", visits, expdate, "/", null, false);
    }
    $.ajax({
        url:'/Mobile/ajaxRecommendQueue',
        data:{visits:visits,appItemId:"",itemId:"532"},
        success:function(data){
            var html ='';
            if(data.success){
                if(data.recommendQueueList.length >= 2){ $('.recommandLocation').show();$('.recommandLocationItems').show()}else{ $('.recommandLocation').hide();$('.recommandLocationItems').hide()}
                for(var i=0; i<data.recommendQueueList.length; i++){
                    var money = '';
                    if (data.recommendQueueList[i].money != null && data.recommendQueueList[i].money != '') {
                        money = ' + ' + data.recommendQueueList[i].money;
                    }
                    html += '<a href="' + data.recommendQueueList[i].url + '">'
                            +    '<div class="recommandBj">'
                            +        '<img src="' + data.recommendQueueList[i].logo + '">'
                            +        '<h2>' + data.recommendQueueList[i].title + '</h2>'
                            +        '<p>' + data.recommendQueueList[i].credits + money + '</p>'
                            +    '</div>'
                            +'</a>';
                }
                $('.recommandLocationItems').html(html);
                var expdate = new Date();
                expdate.setTime(expdate.getTime() + (data.times * 1000));
                SetCookie("visits", visits, expdate, "/", null, false);
            }
        }
    })
</script>
<script src="../js/crpto.min.js" type="text/javascript"></script>

<script type="text/javascript">
    Zepto(function($) {
        /**
         * 链接转换
         */
        var isOpen = false
        var links = $('[data-tag="is-link"]')

        links.each(function() {
            if (isOpen) {
                var text = $(this).text()
                $(this).replaceWith('<span>' + text + '</span>')
            } else {
                $(this).removeAttr('data-tag')
            }
        })
    })
</script>
</html>